{% extends 'layout.html' %}

{% block title %}Communication{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    .communication-page {
        background-color: #f8f9fa;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
    }

    .communication-page .container {
        padding: 15px;
    }

    .communication-page .text-primary {
        color: #8b0000 !important;
        font-size: 20px;
        text-align: center;
        margin-top: 10px;
    }

    .communication-page .plus-btn a {
        font-size: 13px;
        border-radius: 7px;
        background: #800000;
        padding: 8px 12px;
        color: white;
        font-weight: 600;
        text-decoration: none;
    }

    .communication-page .plus-btn a:hover {
        background-color: #a10000;
    }

    .communication-page .dashboard-section {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .communication-page h5,
    .communication-page h2 {
        font-size: 15px;
        text-align: center;
        color: #8b0000;
    }

    .communication-page .card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        padding: 15px;
        background-color: white;
    }

    .communication-page .text-white {
        color: #8b0000 !important;
    }

    .communication-page .badge {
        font-size: 11px;
        padding: 0.3em 0.6em;
    }

    .communication-page .badge-success { background-color: #28a745; }
    .communication-page .badge-danger { background-color: #b30000; }
    .communication-page .bg-warning { background-color: #ffc107 !important; color: #000; }

    .communication-page .scroll-table {
        overflow-x: auto;
    }

    .communication-page table {
        width: 100%;
        font-size: 11px;
        border-collapse: collapse;
    }

    .communication-page th,
    .communication-page td {
        text-align: center;
        padding: 4px;
        border: 1px solid #dee2e6;
    }

    .communication-page thead {
        background-color: #800000;
        color: white;
    }

    .communication-page .chart-container {
        position: relative;
        width: 100%;
        height: 220px;
        max-height: 250px;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .communication-page canvas {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }

    @media (max-width: 768px) {
        .communication-page .container {
            padding: 10px;
        }

        .communication-page .text-primary {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .communication-page .dashboard-section {
            flex-direction: column;
        }

        .communication-page .card h2 {
            font-size: 18px;
        }

        .communication-page table th,
        .communication-page table td {
            font-size: 10px;
            padding: 3px;
        }

        .communication-page .plus-btn {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
        }

        .communication-page .chart-container {
            height: 180px;
            max-height: 200px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="communication-page">
    <div class="container py-3">
        <h2 class="fw-bold text-primary">Communication</h2>
        <div class="plus-btn mb-3">
            <a href="{% url 'upload_excel' %}" title="Upload Excel for Communication">
                <i class="bi bi-file-earmark-arrow-up"></i> Bulk Upload
            </a>
        </div>

        <!-- KPI Cards -->
        <div class="dashboard-section">
            <div class="card text-white text-center">
                <h5>Total Messages Sent</h5>
                <h2>{{ total_messages_sent }}</h2>
            </div>
            <div class="card text-white text-center">
                <h5>Enquiry WhatsApp Messages Sent</h5>
                <h2>{{ enquiry_total_sent }}</h2>
            </div>
            <div class="card text-white text-center">
                <h5>Admission Open Messages Sent</h5>
                <h2>{{ sentmessage_sent }}</h2>
            </div>
            <div class="card text-white text-center">
                <h5>Pending Admission Messages</h5>
                <h2>{{ sentmessage_pending }}</h2>
            </div>
        </div>

        <!-- Recent Messages -->
        <div class="dashboard-section mt-4">
            <!-- Enquiry Section -->
            <div class="card mb-3">
                <h5 class="text-secondary mb-2">Recent Enquiry WhatsApp Messages</h5>
                <div class="scroll-table">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>Enquiry No</th>
                                <th>Student</th>
                                <th>Phone</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for msg in recent_enquiry_msgs %}
                            <tr>
                                <td>{{ msg.enquiry_no }}</td>
                                <td>{{ msg.student_name }}</td>
                                <td>{{ msg.parent_phone }}</td>
                                <td>
                                    <span class="badge
                                        {% if msg.whatsapp_status|lower == 'sent' %} badge-success
                                        {% elif msg.whatsapp_status|lower == 'failed' %} badge-danger
                                        {% else %} bg-warning
                                        {% endif %}">{{ msg.whatsapp_status|title }}</span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="4">No recent enquiry messages found.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card mb-3">
                <h5 class="text-secondary mb-2">Enquiry Message Status</h5>
                <div class="chart-container">
                    <canvas id="enquiryStatusChart"></canvas>
                </div>
            </div>

            <!-- Admission Section -->
            <div class="card mb-3">
                <h5 class="text-secondary mb-2">Recent Admission WhatsApp Messages</h5>
                <div class="scroll-table">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>Phone</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for msg in recent_sentmessage_msgs %}
                            <tr>
                                <td>{{ msg.phone }}</td>
                                <td>
                                    <span class="badge
                                        {% if msg.status|lower == 'sent' %} badge-success
                                        {% elif msg.status|lower == 'failed' %} badge-danger
                                        {% else %} bg-warning
                                        {% endif %}">{{ msg.status|title }}</span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="2">No recent admission messages found.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h5 class="text-secondary mb-2">Admission Message Status</h5>
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const chartOptions = {
    responsive: true,
    maintainAspectRatio: false,
    indexAxis: 'y',
    plugins: { legend: { display: false } },
    scales: { x: { beginAtZero: true } }
};

const ctx = document.getElementById('statusChart').getContext('2d');
new Chart(ctx, {
    type: 'bar',
    data: {
        labels: {{ status_labels|safe }},
        datasets: [{
            data: {{ status_counts|safe }},
            backgroundColor: ['#28a745', '#ffc107', '#dc3545', '#6c757d']
        }]
    },
    options: chartOptions
});

const ctx2 = document.getElementById('enquiryStatusChart').getContext('2d');
new Chart(ctx2, {
    type: 'bar',
    data: {
        labels: {{ enquiry_status_labels|safe }},
        datasets: [{
            data: {{ enquiry_status_counts|safe }},
            backgroundColor: ['#28a745', '#ffc107', '#dc3545', '#6c757d']
        }]
    },
    options: chartOptions
});
</script>
{% endblock %}
