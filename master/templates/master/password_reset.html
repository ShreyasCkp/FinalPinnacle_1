{% extends 'master/bare.html' %}

{% block title %}Reset Password{% endblock %}

{% block content %}
<style>
    body {
        background-color: #f7f8f8;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
    }

    h2 {
        text-align: center;
        color: #800000;
        font-size: 24px;
        margin-top: 20px;
        margin-bottom: 20px;
    }

    #resetForm {
        max-width: 400px;
        width: 90%;
        margin: 0 auto;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        padding: 25px;
        display: flex;
        flex-direction: column;
        align-items: center;
        box-sizing: border-box;
    }

    .form-group {
        width: 100%;
        margin-bottom: 15px;
        display: flex;
        flex-direction: column;
        text-align: left;
    }

    label {
        font-weight: 600;
        color: #333;
        font-size: 14px;
        margin-bottom: 5px;
    }

    .input-field {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.2s ease;
    }

    .input-field:focus {
        outline: none;
        border-color: #800000;
        box-shadow: 0 0 4px rgba(128, 0, 0, 0.3);
    }

    button[type="submit"] {
        background-color: #800000;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        padding: 10px 20px;
        cursor: pointer;
        margin-top: 10px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    button[type="submit"]:hover {
        background-color: #a00000;
    }

    a {
        margin-top: 15px;
        text-align: center;
        display: block;
        text-decoration: none;
        color: #800000;
        font-weight: 600;
        font-size: 14px;
    }

    a:hover {
        text-decoration: underline;
    }

    #password-hints {
        list-style: none;
        padding-left: 0;
        color: red;
        font-size: 12px;
        margin-top: 5px;
        margin-bottom: 5px;
    }

    #passcode-error,
    #confirm-error {
        color: red;
        text-align: center;
        font-size: 13px;
        margin-top: 5px;
    }

    .alert {
        color: red;
        text-align: center;
        font-size: 14px;
        margin-bottom: 10px;
    }

    /* âœ… Mobile Responsive */
    @media (max-width: 768px) {
        h2 {
            font-size: 20px;
            margin-bottom: 15px;
        }

        #resetForm {
            width: 95%;
            padding: 18px;
            box-shadow: none;
            border: 1px solid #ddd;
        }

        label {
            text-align: left;
            font-size: 13px;
        }

        .input-field {
            font-size: 13px;
            padding: 8px;
        }

        button[type="submit"] {
            width: 100%;
            font-size: 14px;
            padding: 10px;
        }

        a {
            font-size: 13px;
        }
    }
</style>

<h2>Reset Password</h2>

{% if error %}
<div class="alert">{{ error }}</div>
{% endif %}

<form method="post" autocomplete="off" id="resetForm">
    {% csrf_token %}

    <div class="form-group">
        <label for="username">Username</label>
        <select name="username" class="input-field" required id="username" {% if username %}disabled{% endif %}>
            <option value="">Select User</option>
            {% for user in users %}
            <option value="{{ user.username }}" {% if username == user.username %}selected{% endif %}>
                {{ user.username }}
            </option>
            {% endfor %}
        </select>
        {% if username %}
        <input type="hidden" name="username" value="{{ username }}">
        {% endif %}
    </div>

    <div class="form-group">
        <label for="passcode">Passcode</label>
        <input type="password" name="passcode" id="passcode" placeholder="Enter Passcode"
               class="input-field" minlength="4" maxlength="10" required autocomplete="off">
        <div id="passcode-error" style="display: none;">
            Passcode is wrong. Please contact admin.
        </div>
    </div>

    <div class="form-group" id="password-section" style="{% if stage == 'set_new_password' %}display:block;{% else %}display:none;{% endif %}">
        <label for="new_password">New Password</label>
        <input type="password" name="new_password" id="new_password" placeholder="Enter New Password"
               class="input-field" minlength="8" maxlength="16" required autocomplete="new-password">

        <ul id="password-hints">
            <li id="pw-length" style="display:none;">At least 8 characters</li>
            <li id="pw-capital" style="display:none;">At least one capital letter</li>
            <li id="pw-special" style="display:none;">At least one special character (!@#$%^&*(),.?":{}|&lt;&gt;)</li>
            <li id="pw-number" style="display:none;">At least one number</li>
        </ul>

        <label for="confirm_password">Confirm Password</label>
        <input type="password" name="confirm_password" id="confirm_password" placeholder="Confirm New Password"
               class="input-field" minlength="8" maxlength="16" required autocomplete="new-password">

        <div id="confirm-error" style="display: none;">Passwords do not match</div>
    </div>

    <button type="submit" name="password_reset_submit" value="1">
        {% if stage == 'set_new_password' %}Set New Password{% else %}Reset Password{% endif %}
    </button>

    <a href="{% url 'login' %}{% if username %}?username={{ username }}{% endif %}">Back to Login</a>
</form>

{% if success_message %}
<script>
    alert("{{ success_message }}");
    window.location.href = "{% url 'login' %}?username={{ username }}";
</script>
{% endif %}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const usernameSelect = document.getElementById('username');
        const passcodeInput = document.getElementById('passcode');
        const errorDiv = document.getElementById('passcode-error');
        const passwordSection = document.getElementById('password-section');

        function checkPasscode() {
            let username = usernameSelect.value;
            const hiddenInput = document.querySelector('input[type="hidden"][name="username"]');
            if (!username && hiddenInput) {
                username = hiddenInput.value;
            }

            const passcode = passcodeInput.value;
            if (!username || !passcode) {
                passwordSection.style.display = 'none';
                return;
            }

            fetch("{% url 'verify_passcode_view' %}", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ username: username, passcode: passcode })
            })
            .then(res => res.json())
            .then(data => {
                if (data.valid) {
                    errorDiv.style.display = 'none';
                    passwordSection.style.display = 'block';
                } else {
                    errorDiv.style.display = 'block';
                    passwordSection.style.display = 'none';
                }
            });
        }

        passcodeInput.addEventListener('input', function () {
            if (passcodeInput.value.length >= 4) {
                checkPasscode();
            } else {
                passwordSection.style.display = 'none';
            }
        });

        {% if stage == 'set_new_password' %}
        const passwordInput = document.getElementById('new_password');
        const confirmInput = document.getElementById('confirm_password');
        const hints = {
            length: document.getElementById('pw-length'),
            capital: document.getElementById('pw-capital'),
            special: document.getElementById('pw-special'),
            number: document.getElementById('pw-number')
        };
        const confirmError = document.getElementById('confirm-error');

        function validatePassword() {
            const value = passwordInput.value;

            hints.length.style.display = value.length < 8 ? 'block' : 'none';
            hints.capital.style.display = /[A-Z]/.test(value) ? 'none' : 'block';
            hints.special.style.display = /[!@#$%^&*(),.?":{}|<>]/.test(value) ? 'none' : 'block';
            hints.number.style.display = /[0-9]/.test(value) ? 'none' : 'block';
        }

        function validateConfirm() {
            confirmError.style.display = (confirmInput.value === passwordInput.value) ? 'none' : 'block';
        }

        passwordInput.addEventListener('input', validatePassword);
        confirmInput.addEventListener('input', validateConfirm);
        {% endif %}
    });
</script>
{% endblock %}
