{% extends 'layout.html' %}
{% block title %}Declare Fees for {{ student.student_name }}{% endblock %}

{% block content %}
<style>
    /* Styles from your Student Attendance form */
    .form-section {
        background: #fff;
        padding: 31px;
        border-radius: 12px;
        margin: 40px auto;
        width: 904px;
        box-shadow: 0 4px 24px rgba(0,0,0,0.08);
    }

    .firsts {
        display: flex;
        align-items: center;
        gap: 12px;
        margin: 20px;
    }

    select, input[type="date"], input[type="number"] {
        padding: 6px;
        font-size: 13px;
        min-width: 140px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    .btn-save {
        background-color: #800000;
        font-weight: 500;
        padding: 5px 16px;
        font-size: 14px;
        color: white;
        border: none;
        border-radius: 8px;
    }

        .btn-save:hover {
            background-color: #800000;
        }

    .btn-back {
        background-color: #800000;
        color: #fff;
        border: 2px solid #800000;
        padding: 2px 5px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.2s ease;
    }

        .btn-back:hover {
            background-color: #800000;
            color: white;
        }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    th, td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center;
        font-size: 12px;
    }

    th {
        background: #800;
        color: #fff;
    }

    .content {
        margin-left: 200px;
        padding: 8px 26px 40px;
        min-height: 100vh;
    }


    .icon-btn {
        border: 1px solid #dee2e6;
        background-color: #fff;
        padding: 3px 5px;
        margin: 2px;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.2s;
        display: inline-block;
        text-decoration: none;
    }

        .icon-btn i {
            font-size: 11px;
            color: #800000;
        }

        .icon-btn.text-danger i {
            color: #b30000;
        }

        .icon-btn:hover {
            background-color: #f3f3f3;
        }

    .btn-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
    }

    .btn-back {
        background-color: #800000;
        color: #fff;
        border: 2px solid #800000;
        padding: 2px 5px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.2s ease;
    }

        .btn-back:hover {
            background-color: #800000;
            color: white;
        }

    .btn-save {
        background-color: #800000;
        font-weight: 600;
        padding: 2px 4px;
        border-radius: 6px;
        font-size: 12px;
        color: white;
        width: 59px;
        border: none;
        cursor: pointer;
    }

        .btn-save:hover {
            background-color: #a10000;
        }
</style>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


<div class="form-section">
    <h3 style="text-align: center; color: #800000;">Declare Fees for {{ student.student_name }}</h3>
    <form method="post">
        {% csrf_token %}
        <table>
            <thead>
                <tr>
                    <th>Fee Type</th>
                    <th>Amount</th>
                    <th>Due Date</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="fee-rows">
                <!-- ðŸ‘‡ This is empty now -->
            </tbody>
        </table>
        <div class="btn-container d-flex justify-content-between mt-4">

            <button type="button" class="btn-back" onclick="addRow()">Add Fee</button>
            <button type="submit" class="btn-save">Save</button>
        </div>



    </form>
</div>
<script>
let rowCount = 1;

const feeOptions = [
    {% for fee in fee_types %}
    { id: '{{ fee.id }}', name: '{{ fee.name|lower }}' },
    {% endfor %}
];

    function addRow() {
        rowCount++;
        const row = document.createElement('tr');

        let optionsHtml = '<option value="">-- Select Fee Type --</option>';
        for (const fee of feeOptions) {
            optionsHtml += `<option value="${fee.id}" data-name="${fee.name}">${capitalize(fee.name)}</option>`;
        }

        row.innerHTML = `
<td>
    <select name="fee_type_${rowCount}" class="form-control fee-type">
        ${optionsHtml}
    </select>
    <div class="fee-type-error" style="color: red; font-size: 11px; display: none;"></div>
</td>
<td>
    <input type="number" step="0.01" name="amount_${rowCount}" class="form-control amount-input" placeholder="Enter amount">
    <div class="amount-error" style="color: red; font-size: 11px; display: none;"></div>
</td>
<td>
    <input type="date" name="due_date_${rowCount}" class="form-control due-date-input" min="${new Date().toISOString().split('T')[0]}">
    <div class="due-date-error" style="color: red; font-size: 11px; display: none;"></div>
</td>
<td>
    <a href="javascript:void(0);" class="icon-btn text-danger" title="Delete" onclick="removeRow(this)">
        <i class="fas fa-trash-alt"></i>
    </a>
</td>
`;

        document.getElementById('fee-rows').appendChild(row);
        handleMutualExclusion();

        // âœ… Add live validation listeners:
        row.querySelector('.fee-type').addEventListener('change', function () {
            const errorDiv = row.querySelector('.fee-type-error');
            errorDiv.style.display = this.value ? 'none' : 'block';
            errorDiv.textContent = this.value ? '' : 'âš ï¸ Fee Type is required.';
            handleMutualExclusion();
        });

        row.querySelector('.amount-input').addEventListener('input', function () {
            const errorDiv = row.querySelector('.amount-error');
            errorDiv.style.display = this.value && parseFloat(this.value) > 0 ? 'none' : 'block';
            errorDiv.textContent = (!this.value || parseFloat(this.value) <= 0) ? 'âš ï¸ Amount must be greater than 0.' : '';
        });

        row.querySelector('.due-date-input').addEventListener('change', function () {
            const feeType = row.querySelector('.fee-type');
            const feeName = feeType.options[feeType.selectedIndex]?.getAttribute('data-name') || "";
            const isDueRequired = feeName !== 'scholarship' && feeName !== 'discount';
            const errorDiv = row.querySelector('.due-date-error');
            const today = new Date().toISOString().split('T')[0];
            // Due Date Validation (only if visible and required)
            if (isDueRequired && dueDate.offsetParent !== null) {
                if (!dueDate.value) {
                    dueDateError.textContent = "Due Date is required.";
                    dueDateError.style.display = "block";
                    dueDate.classList.add('error-border');
                    isValid = false;
                } else if (dueDate.value < today) {
                    dueDateError.textContent = "âš ï¸ Due Date cannot be in the past.";
                    dueDateError.style.display = "block";
                    dueDate.classList.add('error-border');
                    isValid = false;
                }
            } else {
                // Ensure no stale error if hidden
                dueDateError.style.display = "none";
                dueDate.classList.remove('error-border');
            }

        });
    }



function removeRow(btn) {
    btn.closest('tr').remove();
    handleMutualExclusion();
}

function capitalize(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
}
    function handleMutualExclusion() {
        const selectedValues = [];
        let hasHostel = false;
        let hasTransport = false;

        document.querySelectorAll('.fee-type').forEach(select => {
            const selectedOption = select.options[select.selectedIndex];
            const feeName = selectedOption.getAttribute('data-name');
            const row = select.closest('tr');
            const dueDateField = row.querySelector('input[type="date"]');
            const rowSuffix = select.name.split('_')[2];  // Extract suffix from "fee_type_X"

            // Hide due date for scholarship or discount and remove from submission
            if (feeName === 'scholarship' || feeName === 'discount') {
                dueDateField.style.display = 'none';
                dueDateField.removeAttribute('name');
            //    dueDateField.removeAttribute('required');
            } else {
                dueDateField.style.display = 'block';
                dueDateField.setAttribute('name', `due_date_${rowSuffix}`);
            //    dueDateField.setAttribute('required', 'required');
            }


            if (feeName === 'hostel') hasHostel = true;
            if (feeName === 'transport') hasTransport = true;

            if (select.value) {
                selectedValues.push(select.value);
            }
        });

        document.querySelectorAll('.fee-type').forEach(select => {
            const currentValue = select.value;
            Array.from(select.options).forEach(opt => {
                const name = opt.getAttribute('data-name');
                opt.disabled = false;

                if (selectedValues.includes(opt.value) && opt.value !== currentValue) {
                    opt.disabled = true;
                }

                // âœ… New condition: also disable if already collected from DB
                if (alreadyCollectedFeeTypeIds.has(parseInt(opt.value))) {
                    if (opt.value !== currentValue) {
                        opt.disabled = true;
                    }
                }

                // ðŸ‘‡ NEW: Disable if mutually excluded from backend
                if (disabledFeeTypeIds.has(parseInt(opt.value))) {
                    if (opt.value !== currentValue) {
                        opt.disabled = true;
                    }
                }


                if (hasHostel && name === 'transport') opt.disabled = true;
                if (hasTransport && name === 'hostel') opt.disabled = true;
            });
        });
    }
</script>

<script>
const disabledFeeTypeIds = new Set([
    {% for id in disabled_fee_type_ids %}
    {{ id }}{% if not forloop.last %},{% endif %}
    {% endfor %}
]);
</script>
<script>
const alreadyCollectedFeeTypeIds = new Set([
    {% for id in collected_fee_types %}
    {{ id }}{% if not forloop.last %},{% endif %}
    {% endfor %}
]);
</script>

<script>
    if (feeName === 'scholarship') {
        dueDateField.style.display = 'none';
        dueDateField.removeAttribute('name');  // prevent submission
    } else {
        dueDateField.style.display = 'block';
        dueDateField.setAttribute('name', `due_date_${rowCount}`);
    }

</script>
<script>
    document.querySelector('form').addEventListener('submit', function (e) {
        const rows = document.querySelectorAll('#fee-rows tr');
        let isValid = true;
        const today = new Date().toISOString().split('T')[0];

        if (rows.length === 0) {
            alert("âš ï¸ Please add at least one fee row.");
            e.preventDefault();
            return;
        }

        rows.forEach((row) => {
            const feeType = row.querySelector('.fee-type');
            const amount = row.querySelector('.amount-input');
            const dueDate = row.querySelector('.due-date-input');

            const feeTypeError = row.querySelector('.fee-type-error');
            const amountError = row.querySelector('.amount-error');
            const dueDateError = row.querySelector('.due-date-error');

            const feeName = feeType.options[feeType.selectedIndex]?.getAttribute('data-name') || "";
            const isDueRequired = feeName !== 'scholarship' && feeName !== 'discount';

            // Reset styles & messages
            [feeType, amount, dueDate].forEach(input => input?.classList.remove('error-border'));
            feeTypeError.textContent = "";
            amountError.textContent = "";
            dueDateError.textContent = "";

            // Fee Type Validation
            if (!feeType.value) {
                feeTypeError.textContent = "Fee Type is required.";
                feeTypeError.style.display = "block";
                feeType.classList.add('error-border');
                isValid = false;
            }

            // Amount Validation
            if (!amount.value || parseFloat(amount.value) <= 0) {
                amountError.textContent = "Amount must be greater than 0.";
                amountError.style.display = "block";
                amount.classList.add('error-border');
                isValid = false;
            }

            // Due Date Validation (conditionally required)
            if (isDueRequired) {
                if (!dueDate.value) {
                    dueDateError.textContent = "Due Date is required.";
                    dueDateError.style.display = "block";
                    dueDate.classList.add('error-border');
                    isValid = false;
                } else if (dueDate.value < today) {
                    dueDateError.textContent = "âš ï¸ Due Date cannot be in the past.";
                    dueDateError.style.display = "block";
                    dueDate.classList.add('error-border');
                    isValid = false;
                }
            }
        });

        if (!isValid) {
            e.preventDefault(); // block form submit if any error found
        }
    });
</script>

<style>
    .error-border {
        border: 1px solid red !important;
    }

    td {
        text-align: left; /* Make text alignment consistent */
        vertical-align: top; /* So error messages come right below the input */
    }

        td > div {
            margin-top: 2px;
            font-size: 11px;
            color: red;
            text-align: left; /* Ensure left alignment for errors */
        }
</style>


{% endblock %}
