{% extends 'layout.html' %}


<style>
@media (max-width: 768px) {
  .topbar { left: 0; }
  .main-area, .content, .footer { margin-left: 0 !important; padding: 70px 16px 24px !important; }
  table { display: block; overflow-x: auto; white-space: nowrap; }
}
@media (max-width: 480px) {
  .container { max-width: 100%; margin: 0; border-radius: 0; padding: 16px; }
}
</style>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

<style>
    body {
        background-color: #f0f2f5;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .page-wrapper {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding: 20px 0;
        min-height: 100vh;
    }

    .container {
        width: 95%;
        max-width: 1200px;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
        padding: 30px;
        font-size: 11px;
    }

    h2 {
        font-weight: 700;
        color: #800000;
        font-size: 22px;
        text-align: center;
    }

    table {
        width: 100%;
        font-size: 11px;
        border-collapse: collapse;
        margin-top: 10px;
    }

    th, td {
        vertical-align: middle !important;
        text-align: center;
        padding: 6px;
        border: 1px solid #dee2e6;
    }

    thead {
        background: linear-gradient(135deg, #8B0000, #800000);
        color: white;
    }

    tr:nth-child(even) {
        background-color: #f8f9fa;
    }

    td:hover {
        background-color: #e9ecef;
    }

    .btn-primary {
        background-color: #800000;
        border: none;
        font-size: 11px;
        padding: 5px 12px;
        border-radius: 4px;
    }

        .btn-primary:hover {
            background-color: #a52a2a;
        }

    .btn-secondary {
        font-size: 11px;
        padding: 5px 12px;
        border-radius: 4px;
    }

    .card {
        border-radius: 12px;
        box-shadow: 0 4px 18px rgba(0,0,0,0.05);
        padding: 20px;
        margin-bottom: 25px;
    }

    .modal-title {
        font-size: 14px;
        font-weight: 600;
    }

    .modal-body select, .modal-body input {
        font-size: 12px;
    }

    #qr-section img {
        max-width: 150px;
        border: 4px solid #800000;
        border-radius: 8px;
    }

    #qr-section p {
        font-size: 11px;
        margin-top: 6px;
    }

    .fee-table-scroll tbody {
        display: block;
        max-height: 400px;
        overflow-y: auto;
    }

        .fee-table-scroll thead, .fee-table-scroll tbody tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }

    #total-amount {
        background-color: #cce5ff;
        color: #004085;
        font-weight: bold;
    }

    #total-paid {
        background-color: #d4edda;
        color: #155724;
        font-weight: bold;
    }

    #total-balance {
        background-color: #fff3cd;
        color: #856404;
        font-weight: bold;
    }

    #total-current-paid {
        background-color: #f8d7da;
        color: #721c24;
        font-weight: bold;
    }

    .status-paid {
        color: green;
        font-weight: bold;
    }

    .status-pending {
        color: red;
        font-weight: bold;
    }

    .status-partial {
        color: orange;
        font-weight: bold;
    }

    .color-legend div {
        display: inline-block;
        margin-right: 10px;
        font-size: 12px;
    }

    .color-box {
        display: inline-block;
        width: 12px;
        height: 12px;
        margin-right: 4px;
        vertical-align: middle;
        border: 1px solid #ccc;
    }
</style>

<div class="page-wrapper">
    <div class="container">
        <h2>Collect Fees</h2>

        <div class="card">
            <h5 class="text-primary mb-3" style="font-size: 13px;">Student Details</h5>
            <table class="table table-bordered table-sm">
                <tbody>
                    <tr><th>Image</th><td>No Image</td><th>Name</th><td>{{ student.student_name }}</td><th>Father Name</th><td>{{ student.admission_father_name }}</td></tr>
                    <tr><th>Course Type</th><td>{{ student.admission_course_type }}</td><th>Course</th><td>{{ student.admission_course }}</td><th>Admission No</th><td>{{ student.admission_no }}</td></tr>
                    <tr><th>DOB</th><td>{{ student.admission_dob }}</td><th>Academic Year</th><td>{{ student.admission_academic_year }}</td><th>Mobile</th><td>{{ student.admission_father_mobile_no }}</td></tr>
                    <tr><th>Roll Number</th><td>{{ student.roll_number }}</td><th>Category</th><td>{{ student.category }}</td><th>Date</th><td>{{ now|date:"d-m-Y" }}</td></tr>
                </tbody>
            </table>
        </div>

        <div class="card">
            <form id="collect-fee-form" method="POST" action="{% url 'fee_collection_collect' %}">
                {% csrf_token %}
                <input type="hidden" name="admission_no" value="{{ student.admission_no }}">
                <div class="fee-table-container">
                    <table class="table table-bordered table-sm fee-table-scroll">
                        <thead>
                            <tr>
                                <th>Select</th>
                                <th>Fee Name</th>
                                <th>Due Date</th>
                                <th>Amount (â‚¹)</th>
                                <th>Received (â‚¹)</th>
                                <th>Balance (â‚¹)</th>
                                <th>Status</th>
                                <th>Amount To Be Paid (â‚¹)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% regroup fee_collections by fee_type as fee_type_list %}
                            {% for group in fee_type_list %}
                            <tr class="bg-light font-weight-bold"><td colspan="8">{{ group.grouper.fee_name }}</td></tr>
                            {% for fee in group.list %}
                            <tr class="fee-row">
                                <td>
                                    {% if fee.status != 'Paid' %}
                                    <input type="checkbox" name="selected_fees" value="{{ fee.id }}" class="fee-checkbox">
                                    {% else %}<span class="text-success font-weight-bold">Paid</span>{% endif %}
                                </td>
                                <td>{{ fee.fee_type.fee_name }}{% if fee.installment_number %} | Installment {{ fee.installment_number }}{% endif %}</td>
                                <td>{{ fee.fee_type.due_date|date:"d-m-Y" }}</td>
                                <td class="fee-amount">{{ fee.amount }}</td>
                                <td class="fee-paid" data-original="{{ fee.paid_amount }}">{{ fee.paid_amount }}</td>
                                <td class="fee-balance" data-original="{{ fee.balance_amount }}">{{ fee.balance_amount }}</td>
                                <td class="{% if fee.status == 'Paid' %}status-paid{% elif fee.status == 'Pending' %}status-pending{% elif fee.status == 'Partial' %}status-partial{% endif %}">
                                    {{ fee.status }}
                                </td>
                                <td>
                                    {% if fee.status != 'Paid' %}
                                    <input type="number" name="paid_amount_{{ fee.id }}" min="0" max="{{ fee.balance_amount }}" step="0.01" class="form-control form-control-sm amount-input" disabled placeholder="0.00">
                                    {% else %}-{% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                            {% endfor %}
                            <tr class="font-weight-bold bg-secondary text-white">
                                <td colspan="3" class="text-right">Total Amount:</td>
                                <td id="total-amount">0.00</td>
                                <td id="total-paid">0.00</td>
                                <td id="total-balance">0.00</td>
                                <td colspan="2">Total Amount Paid:</td>
                                <td id="total-current-paid">0.00</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="mt-2 color-legend">
                        <div><span class="color-box" style="background-color: #cce5ff;"></span> Total Amount</div>
                        <div><span class="color-box" style="background-color: #d4edda;"></span> Total Paid</div>
                        <div><span class="color-box" style="background-color: #fff3cd;"></span> Total Balance</div>
                        <div><span class="color-box" style="background-color: #f8d7da;"></span> Total Amount Paid Now</div>
                        <div><span class="color-box" style="background-color: green;"></span> Paid</div>
                        <div><span class="color-box" style="background-color: red;"></span> Pending</div>
                        <div><span class="color-box" style="background-color: orange;"></span> Partial</div>
                    </div>

                    <div class="text-center mt-3">
                        <button type="button" class="btn btn-primary" id="collect-btn" disabled>Collect Fee</button>
                        <a href="{% url 'student_fee_list' %}" class="btn btn-secondary ml-2">Cancel</a>
                    </div>
            </form>
        </div>
    </div>
</div>

<!-- Payment Mode Modal -->
<div class="modal fade" id="paymentModeModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <form id="payment-mode-form" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Payment Mode</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <select class="form-control" id="payment_mode" required>
                    <option value="">Select Payment Mode</option>
                    <option value="Cash">Cash</option>
                    <option value="Online">Online</option>
                </select>
                <div id="qr-section" class="text-center mt-3" style="display:none;">
                    <img id="qr-img" src="" alt="QR Code">
                    <p>Scan and pay using your UPI app</p>
                </div>
                <input type="text" class="form-control mt-2" id="payment_reference" placeholder="Transaction Reference (if applicable)">
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Confirm Payment</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
    $(document).ready(function () {
        const checkboxes = $('.fee-checkbox');
        const amountInputs = $('.amount-input');
        const collectBtn = $('#collect-btn');

        let totalAmount = 0, totalPaid = 0, totalBalance = 0;
        $('.fee-row').each(function () {
            totalAmount += parseFloat($(this).find('.fee-amount').text()) || 0;
            totalPaid += parseFloat($(this).find('.fee-paid').text()) || 0;
            totalBalance += parseFloat($(this).find('.fee-balance').text()) || 0;
        });
        $('#total-amount').text(totalAmount.toFixed(2));
        $('#total-paid').text(totalPaid.toFixed(2));
        $('#total-balance').text(totalBalance.toFixed(2));

        checkboxes.change(function () {
            const row = $(this).closest('tr');
            if ($(this).is(':checked')) {
                row.find('.amount-input').prop('disabled', false);
            } else {
                row.find('.amount-input').prop('disabled', true).val('');
                row.find('.fee-paid').text(row.find('.fee-paid').attr('data-original'));
                row.find('.fee-balance').text(row.find('.fee-balance').attr('data-original'));
            }
            collectBtn.prop('disabled', checkboxes.filter(':checked').length === 0);
            updateFooterForSelected();
        });

        amountInputs.on('input', function () {
            const row = $(this).closest('tr');
            const enteredPaid = parseFloat($(this).val()) || 0;
            const originalPaid = parseFloat(row.find('.fee-paid').attr('data-original')) || 0;
            const originalBalance = parseFloat(row.find('.fee-balance').attr('data-original')) || 0;
            row.find('.fee-paid').text((originalPaid + enteredPaid).toFixed(2));
            row.find('.fee-balance').text(Math.max(originalBalance - enteredPaid, 0).toFixed(2));
            updateFooterForSelected();
        });

        function updateFooterForSelected() {
            let paidSum = 0, balanceSum = 0, currentPaidNow = 0;
            $('.fee-row').each(function () {
                const checkbox = $(this).find('.fee-checkbox');
                const originalPaid = parseFloat($(this).find('.fee-paid').attr('data-original')) || 0;
                const currentPaid = parseFloat($(this).find('.fee-paid').text()) || 0;
                if (checkbox.is(':checked')) {
                    paidSum += currentPaid;
                    balanceSum += parseFloat($(this).find('.fee-balance').text()) || 0;
                    currentPaidNow += (currentPaid - originalPaid);
                } else {
                    paidSum += originalPaid;
                    balanceSum += parseFloat($(this).find('.fee-balance').attr('data-original')) || 0;
                }
            });
            $('#total-paid').text(paidSum.toFixed(2));
            $('#total-balance').text(balanceSum.toFixed(2));
            $('#total-current-paid').text(currentPaidNow.toFixed(2));
        }

        $('#collect-btn').click(function () {
            $('#payment_mode').val('');
            $('#payment_reference').val('');
            $('#qr-section').hide();
            $('#paymentModeModal').modal('show');
        });

        $('#payment_mode').change(function () {
            const mode = $(this).val();
            const totalToPay = parseFloat($('#total-current-paid').text()) || 0;
            if (mode === 'Online') {
                $('#qr-img').attr('src', "{% url 'generate_qr_dynamic' %}?amount=" + totalToPay.toFixed(2));
                $('#qr-section').show();
            } else {
                $('#qr-section').hide();
            }
        });

        $('#payment-mode-form').submit(function (e) {
            e.preventDefault();
            $('<input>').attr({ type: 'hidden', name: 'payment_mode', value: $('#payment_mode').val() }).appendTo('#collect-fee-form');
            $('<input>').attr({ type: 'hidden', name: 'payment_reference', value: $('#payment_reference').val() }).appendTo('#collect-fee-form');
            $('#paymentModeModal').modal('hide');
            $('#collect-fee-form').submit();
        });
    });
</script>

{% endblock %}

