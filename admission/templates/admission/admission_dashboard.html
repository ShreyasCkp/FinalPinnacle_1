{% extends 'layout.html' %}
{% block title %}Admission{% endblock %}
{% block content %}

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<div class="container py-5">
    <h2 class="fw-bold text-primary mb-4 text-center">Admission</h2>

    <!-- Upload Form -->
    <div class="upload-form-wrapper mb-3 d-flex justify-content-end flex-wrap">
        <form method="post" enctype="multipart/form-data" id="uploadForm" 
              class="d-flex align-items-center gap-2 flex-wrap w-100 w-md-auto" style="max-width: 320px;">
            {% csrf_token %}
            <input type="file" name="import_file" id="import_file" accept=".xlsx,.xls,.pdf"
                   required class="form-control form-control-sm custom-file-sm flex-fill">
            <button type="submit" class="btn btn-outline-primary btn-sm"
                    style="height: 32px; padding: 4px 12px; font-size: 12px; background: #800000; color: white; border-color: #800000;">
                Upload
            </button>
        </form>
    </div>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        const form = document.getElementById('uploadForm');
        form.addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(form);

            Swal.fire({
                title: 'Uploading...',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            fetch("{% url 'bulk_import_admissions' %}", {
                method: 'POST',
                body: formData,
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        let html = `<b>${data.message}</b>`;
                        if (data.error_count > 0) {
                            html += `<br><br><b>⚠️ ${data.error_count} Record(s) Skipped:</b><ul>`;
                            html += data.errors.map(e => `<li>${e}</li>`).join('');
                            if (data.error_count > 10) {
                                html += `<li>...and ${data.error_count - 10} more.</li>`;
                            }
                            html += `</ul>`;
                        }
                        Swal.fire({
                            icon: data.error_count > 0 ? 'warning' : 'success',
                            title: 'Upload Complete',
                            html: html,
                            width: 350
                        });
                    } else {
                        Swal.fire('❌ Upload Failed', data.error || 'Unknown error occurred.', 'error');
                    }
                })
                .catch(error => {
                    console.error(error);
                    Swal.fire('❌ Upload Failed', 'Something went wrong during upload.', 'error');
                });
        });
    </script>

    <!-- Stats Cards -->
    <div class="row mb-4 g-3">
        <div class="col-6 col-md-3">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body text-center">
                    <h6 class="text-muted">Total PU Admissions <i class="bi bi-person-lines-fill"></i></h6>
                    <h3 class="fw-bold">{{ total_pu_admissions }}</h3>
                </div>
            </div>
        </div>

        <div class="col-6 col-md-3">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body text-center">
                    <h6 class="text-muted">Total Degree Admissions <i class="bi bi-mortarboard"></i></h6>
                    <h3 class="fw-bold">{{ total_degree_admissions }}</h3>
                </div>
            </div>
        </div>

        <div class="col-6 col-md-3">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body text-center">
                    <h6 class="text-muted">Confirmed Admissions <i class="fas fa-user-check me-1" style="color: #800000;"></i></h6>
                    <h3 class="fw-bold">{{ confirmed_admissions }}</h3>
                </div>
            </div>
        </div>

        <div class="col-6 col-md-3">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body text-center">
                    <h6 class="text-muted">Pending Review <i class="fas fa-hourglass-half me-1" style="color: #800000;"></i></h6>
                    <h3 class="fw-bold">{{ pending_review }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Action Buttons -->
    <div class="d-flex flex-wrap justify-content-center gap-2 mb-4">
        <div class="d-flex flex-column align-items-start position-relative">
            <button id="toggle-applications" class="btn btn-maroon px-4 py-2 flex-fill">
                <i class="bi bi-journal-text me-2"></i>Direct Admission
            </button>
            <div id="application-buttons" class="d-none flex-column custom-dropdown w-100">
                <a href="{% url 'admission_form' %}" class="btn btn-maroon my-1">PU Application Form</a>
                <a href="{% url 'degree_admission_form' %}" class="btn btn-maroon my-1">BCOM Application Form</a>
            </div>
        </div>

        <div class="d-flex flex-column align-items-start position-relative">
            <button id="toggle-lists" class="btn btn-maroon px-4 py-2 flex-fill">
                <i class="bi bi-card-list me-2"></i>Application List
            </button>
            <div id="list-buttons" class="d-none flex-column custom-dropdown w-100">
                <a href="{% url 'admission_list' %}" class="btn btn-maroon my-1">PU Application List</a>
                <a href="{% url 'degree_admission_list' %}" class="btn btn-maroon my-1">BCOM Application List</a>
            </div>
        </div>

        <a href="{% url 'pending_admissions' %}" class="btn btn-maroon px-4 py-2 flex-fill">
            <i class="fas fa-hourglass-half me-2"></i>Pending Admissions
        </a>

        <a href="{% url 'confirmed_admissions' %}" class="btn btn-maroon px-4 py-2 flex-fill">
            <i class="fas fa-check-circle me-2"></i>Confirmed Admissions
        </a>

        <button class="btn btn-maroon px-4 py-2 flex-fill load-form" data-url="{% url 'reports' %}">
            <i class="fas fa-chart-bar me-2"></i>Reports
        </button>
    </div>

    <div id="form-container"></div>
</div>

<!-- Bootstrap & Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const appBtn = document.getElementById("toggle-applications");
        const listBtn = document.getElementById("toggle-lists");
        const appSection = document.getElementById("application-buttons");
        const listSection = document.getElementById("list-buttons");

        appBtn.addEventListener("click", () => {
            appSection.classList.toggle("d-none");
            listSection.classList.add("d-none");
        });

        listBtn.addEventListener("click", () => {
            listSection.classList.toggle("d-none");
            appSection.classList.add("d-none");
        });
    });
</script>

<!-- Styles -->
<style>
    body {
        font-family: Arial, sans-serif;
        background: #f7f8f8;
        padding: 0;
    }

    h2 {
        font-size: 22px;
        text-align: center;
    }

    .fw-bold {
        color: #800000;
        font-size: 28px;
    }

    .btn-maroon {
        color: #800000;
        border: 2px solid #800000;
        background-color: white;
        font-size: 13px;
        border-radius: 6px;
        transition: 0.3s;
    }

    .btn-maroon:hover {
        background-color: #800000;
        color: white;
    }

    .card h6 {
        color: #8b0000;
        font-size: 13px;
    }

    .card h3 {
        color: #800000;
        font-size: 22px;
    }

    .custom-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        z-index: 1000;
        background-color: #fff;
        border-radius: 6px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.08);
    }

    .upload-form-wrapper {
        justify-content: flex-end;
    }

    /* ✅ Responsive Design */
    @media (max-width: 768px) {
        h2 {
            font-size: 18px;
        }

        .fw-bold {
            font-size: 22px;
        }

        .btn-maroon {
            font-size: 12px;
            padding: 6px 8px;
            width: 100%;
        }

        .upload-form-wrapper {
            justify-content: center;
        }

        .upload-form-wrapper form {
            flex-direction: column;
            width: 100%;
            max-width: none;
        }

        .upload-form-wrapper input[type=file],
        .upload-form-wrapper button {
            width: 100%;
        }

        .card h3 {
            font-size: 18px;
        }

        .card h6 {
            font-size: 11px;
        }

        .d-flex.flex-wrap.justify-content-center.gap-2.mb-4 {
            flex-direction: column;
            gap: 0.5rem;
        }

        .custom-dropdown {
            width: 100%;
            position: relative;
            box-shadow: none;
        }
    }
</style>

{% endblock %}
