{% extends 'layout.html' %}

{% block title %}Follow-up history{% endblock %}

{% block content %}
<style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
        }

        .container {
            background-color: #ffffff;
            padding: 19px;
            margin-top: -34px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
        }

        .mb-4 {
            margin-bottom: 1.5rem !important;
            text-align: center;
            color: #800000;
            font-size: 22px;
        }

        .table {
            border-radius: 8px;
            overflow: hidden;
            width: 100%;
            font-size: 13px;
            border-collapse: collapse;
        }

            .table th {
                background-color: #800000 !important;
                color: #fff;
                font-weight: 500;
                font-size: 12px;
                text-align: center;
                padding: 2px;
                border: 1px solid #dee2e6;
            }

            .table td {
                vertical-align: middle;
                font-size: 9px;
                text-align: center;
                padding: 1px;
                border: 1px solid #dee2e6;
            }

        .form-select-sm {
            border-radius: 11px;
            font-size: 9px;
            padding: 2px 7px;
            background-color: #800000;
            color: white;
        }

        select.form-select-sm:focus {
            border-color: #0f6bc6;
            box-shadow: 0 0 0 0.2rem rgba(15, 107, 198, 0.25);
        }

        .text-center {
            font-style: italic;
            color: #888;
        }

        popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 8px;
            padding: 20px;
            z-index: 1001;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.3);
            display: none;
            width: 300px;
            text-align: center;
        }

        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 100vw;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
        }

        #confirm-popup-message {
            margin-bottom: 15px;
            font-size: 13px;
            color: #800000;
        }

        #confirm-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            display: none;
            z-index: 1001;
            text-align: center;
        }

        #confirm-yes, #confirm-no {
            margin: 0 5px;
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            background: transparent;
            color: #800000;
            font-weight: 600;
            border: 2px solid #800000;
            transition: all 0.2s ease;
        }

            #confirm-yes:hover, #confirm-no:hover {
                background-color: #800000;
                color: white;
            }

        /*   #confirm-yes,
    #confirm-no {
        margin: 0 5px;
        padding: 6px 12px;
        border: none;
        font-size: 12px;
        border-radius: 4px;
        cursor: pointer;
    }

    #confirm-yes {
        background-color: #800000;
        color: white;
    }

    #confirm-no {
        background-color: #e0e0e0;
    }*/
        #confirm-yes,
        #confirm-no {
            margin: 0 5px;
            padding: 6px 12px;
            border: 2px solid #800000;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            background-color: transparent;
            color: #800000;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
        }

            #confirm-yes:hover {
                background-color: #800000;
                color: #fff;
            }

            #confirm-no:hover {
                background-color: #800000;
                color: #fff;
            }


        .icon-btn {
            border: 1px solid #dee2e6;
            background-color: #fff;
            padding: 3px 5px;
            margin: 2px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: inline-block;
            text-decoration: none;
        }

            .icon-btn i {
                font-size: 11px;
                color: #800000;
            }

            .icon-btn.text-danger i {
                color: #b30000;
            }

        .search-input {
            position: absolute;
            left: 0;
            font-size: 13px;
            width: 220px;
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
</style>

<div class="container mt-5">
    <div class="header-flex" style="position: relative; margin-bottom: 20px;">
        <input type="text" id="followupSearch" placeholder="Search follow-ups..." class="search-input">
        <h3 class="mb-4" style="margin: 0; font-size: 22px; font-weight: 700; color: #800000; text-align: center; width: 100%;">Follow-up History</h3>
    </div>



    <table class="table table-bordered table-striped">
        <thead class="table-dark">
            <tr>
                <th>Sl No</th>
                <th>Enquiry NO</th>
                <th>Names</th>
                <th>Type</th>
                <th>Follow-up Date</th>
                <th>Priority</th>
                <th>Notes</th>
                <th>Next Action</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for f in followups %}
            <tr>
                <td>{{ forloop.counter }}</td>
                <td>
                     {% if f.pu_enquiry %}
                         {{ f.pu_enquiry.enquiry_no }}
                     {% elif f.degree_enquiry %}
                         {{ f.degree_enquiry.enquiry_no }}
                     {% endif %}
                </td>
 
                <!-- Student Name Column -->
                <td>
                     {% if f.pu_enquiry %}
                         {{ f.pu_enquiry.student_name }}
                     {% elif f.degree_enquiry %}
                         {{ f.degree_enquiry.student_name }}
                     {% endif %}
                </td>
                <td>{{ f.follow_up_type }}</td>
                <td>{{ f.follow_up_date|date:"Y-m-d H:i" }}</td>
                <td>{{ f.priority }}</td>
                <td>{{ f.notes }}</td>
                <td>{{ f.next_action_required }}</td>
                <td>
                    <form method="post" action="{% url 'update_followup_status' f.id %}">
                        {% csrf_token %}
                        <select name="status" class="form-select form-select-sm" onchange="this.form.submit()">
                            <option value="Pending" {% if f.status == 'Pending' %}selected{% endif %}>Pending</option>
                            <option value="Completed" {% if f.status == 'Completed' %}selected{% endif %}>Completed</option>
                        </select>
                    </form>
                </td>
                <td>
                    <div style="display: flex; justify-content: center; align-items: center;">
                        {% if form_permissions.schedule_follow_up_form.view %}
                        <a href="{% url 'schedule_follow_up_form_view' f.id %}" class="icon-btn" title="View">
                            <i class="fas fa-eye"></i>
                        </a>
                        {% endif %}

                        {% if form_permissions.schedule_follow_up_form.edit %}
                        <a href="{% url 'schedule_follow_up_form_edit' f.id %}" class="icon-btn" title="Edit">
                            <i class="fas fa-edit"></i>
                        </a>
                        {% endif %}

                        {% if form_permissions.schedule_follow_up_form.delete %}
                        <form id="followup-delete-form-{{ f.id }}" method="post" action="{% url 'schedule_follow_up_form_delete' f.id %}" style="display: none;">
                            {% csrf_token %}
                        </form>
                        <a href="#" class="icon-btn text-danger" title="Delete"
                           onclick="confirmFollowUpDelete(

    '{{ f.id }}',

    '{% if f.pu_enquiry %}{{ f.pu_enquiry.student_name }}{% elif f.degree_enquiry %}{{ f.degree_enquiry.student_name }}{% else %}Student{% endif %}'

)">
                            <i class="fas fa-trash-alt"></i>
                        </a>

                        {% endif %}
                    </div>
                </td>

            </tr>
            {% empty %}
            <tr>
                <td colspan="8" class="text-center">No follow-up records found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<div id="overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:black; opacity:0.5; z-index:1000;"></div>

<div id="confirm-popup" style="display:none; position:fixed; top:30%; left:50%; transform:translate(-50%, -50%);
    background:#fff; padding:20px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.5); z-index:1001;">
    <p id="confirm-popup-message"></p>
    <button id="confirm-yes">Yes</button>
    <button id="confirm-no">No</button>
</div>

<script>
    let currentFollowUpId = null;

    function confirmFollowUpDelete(followupId, studentName) {
        currentFollowUpId = followupId;
        document.getElementById("confirm-popup-message").textContent =
            `Are you sure you want to delete the follow-up for ${studentName}?`;

        document.getElementById("overlay").style.display = "block";
        document.getElementById("confirm-popup").style.display = "block";
    }

    document.getElementById("confirm-no").addEventListener("click", function () {
        document.getElementById("overlay").style.display = "none";
        document.getElementById("confirm-popup").style.display = "none";
        currentFollowUpId = null;
    });

    document.getElementById("confirm-yes").addEventListener("click", function () {
        if (currentFollowUpId) {
            document.getElementById(`followup-delete-form-${currentFollowUpId}`).submit();
        }
    });


    document.getElementById("followupSearch").addEventListener("input", function () {
        const filter = this.value.toLowerCase();
        const rows = document.querySelectorAll("table tbody tr");

        rows.forEach(row => {
            if (row.querySelector("td")?.getAttribute("colspan")) return;

            const enquiry = row.cells[1]?.textContent.toLowerCase() || '';
            const type = row.cells[2]?.textContent.toLowerCase() || '';
            const date = row.cells[3]?.textContent.toLowerCase() || '';
            const priority = row.cells[4]?.textContent.toLowerCase() || '';
            const notes = row.cells[5]?.textContent.toLowerCase() || '';
            const nextAction = row.cells[6]?.textContent.toLowerCase() || '';
            const status = row.cells[7]?.textContent.toLowerCase() || '';

            const match =
                enquiry.includes(filter) ||
                type.includes(filter) ||
                date.includes(filter) ||
                priority.includes(filter) ||
                notes.includes(filter) ||
                nextAction.includes(filter) ||
                status.includes(filter);

            row.style.display = match ? '' : 'none';
        });
    });

</script>

<div id="snackbar"></div>

<script>
    function showSnackbar(message) {
        const snackbar = document.getElementById("snackbar");
        snackbar.textContent = message;
        snackbar.className = "show";
        setTimeout(() => {
            snackbar.className = snackbar.className.replace("show", "");
        }, 3000);
    }

    // Django message support
    {% if messages %}
        {% for message in messages %}
            showSnackbar("{{ message|escapejs }}");
        {% endfor %}
    {% endif %}
</script>

<style>
    #snackbar {
        visibility: hidden;
        min-width: 250px;
        background-color: #800000;
        color: #fff;
        text-align: center;
        border-radius: 4px;
        padding: 14px 24px;
        position: fixed;
        z-index: 9999;
        left: 50%;
        bottom: 30px;
        transform: translateX(-50%);
        font-size: 14px;
    }

        #snackbar.show {
            visibility: visible;
            animation: fadein 0.4s, fadeout 0.4s 2.6s;
        }

    @keyframes fadein {
        from {
            bottom: 0;
            opacity: 0;
        }

        to {
            bottom: 30px;
            opacity: 1;
        }
    }

    @keyframes fadeout {
        from {
            bottom: 30px;
            opacity: 1;
        }

        to {
            bottom: 0;
            opacity: 0;
        }
    }
</style>
{% endblock %}
