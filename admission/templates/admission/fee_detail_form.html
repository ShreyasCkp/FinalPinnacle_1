{% extends 'layout.html' %}

{% block title %}{{ form_title|default:"Student Payment Form" }}{% endblock %}

{% block content %}

{% load form_filters %}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<style>

    .form-control {
        font-size: 10px;
        padding: 4px 8px;
        height: 30px;
    }

    label {
        font-size: 10px;
        margin-bottom: 2px;
    }

    .btn {
        font-size: 10px;
        padding: 4px 10px;
    }

    .row .col-md-4 {
        margin-bottom: 10px;
    }
</style>

<div class="container mt-4">
    <h2 style="font-size:12px; margin-top:70px;" class="mb-4">{{ form_title }}</h2>

    <form method="post">
        {% csrf_token %}

        <!-- Row 1: Auto-filled Admission Details -->
        <div class="row">
            <div class="col-md-4">
                <label>Admission Number</label>
                <input type="text" class="form-control" value="{{ admission.admission_no }}" readonly>
            </div>
            <div class="col-md-4">
                <label>Student Name</label>
                <input type="text" class="form-control" value="{{ admission.student_name }}" readonly>
            </div>
            <div class="col-md-4">
                <label>Course</label>
                <input type="text" class="form-control" value="{{ admission.course|upper }}" readonly>
            </div>
        </div>

        <!-- Row 2: Fee Entry -->
        <div class="row">
            <div class="col-md-4">
                <label>Tuition Fee*</label>
                {{ form.tuition_fee|add_class:"form-control" }}
            </div>
            <div class="col-md-4">
                <label>Scholarship</label>
                {{ form.scholarship|add_class:"form-control" }}
            </div>
            <div class="col-md-4">
                <label>Transport Fee</label>
                {{ form.transport_fee|add_class:"form-control" }}
            </div>
        </div>

        <!-- Row 3: Fee Entry -->
        <div class="row">
            <div class="col-md-4">
                <label>Hostel Fee</label>
                {{ form.hostel_fee|add_class:"form-control" }}
            </div>
            <div class="col-md-4">
                <label>Books Fee*</label>
                {{ form.books_fee|add_class:"form-control" }}
            </div>
            <div class="col-md-4">
                <label>Uniform Fee*</label>
                {{ form.uniform_fee|add_class:"form-control" }}
            </div>
        </div>

        <!-- Tuition Advance -->
        <div class="row">
            <div class="col-md-4">
                <label>Final Fee*</label>
                {{ form.final_fee_after_advance|add_class:"form-control" }}
            </div>

            <div class="col-md-4">
                <label>Tuition Advance Amount*</label>
                {{ form.tuition_advance_amount|add_class:"form-control" }}
            </div>
            <!--<div class="col-md-4">
                <label>Payment Mode</label>
                {{ form.payment_mode|add_class:"form-control" }}
            </div>-->

            <div class="col-md-4 text-end">
                <label>&nbsp;</label>
                <div>
                    <!--<button type="submit" class="btn btn-success">Save</button>-->
                    <a href="{% url 'shortlist_display' %}?type={{ type }}" style="background-color: #800000 !important; " class="btn btn-secondary">Back</a>
                </div>
            </div>
        </div>

        <!-- QR Code -->
        <!--<div class="row">
            <div class="col-md-4" id="qr-code-section" style="display:none;">
                <label>Scan to Pay (QR Code)</label>
                <div>
                    <img id="qr-code-img" src="" alt="QR Code" class="img-fluid border p-2 rounded" />
                </div>
            </div>
        </div>-->
    </form>
</div>


<!--<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    function updateQRCode() {
        let method = $('#id_payment_mode').val();
        let amount = parseFloat($('#id_tuition_advance_amount').val()) || 0;

        if (method === 'Online' && amount > 0) {
            let qrUrl = `{% url 'generate_qr_dynamic' %}?amount=${amount}`;
            $('#qr-code-img').attr('src', qrUrl);
            $('#qr-code-section').show();
        } else {
            $('#qr-code-section').hide();
            $('#qr-code-img').attr('src', '');
        }
    }

    $(document).ready(function () {
        $('#id_payment_mode, #id_tuition_advance_amount').on('change input', updateQRCode);
        updateQRCode();
    });
</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    function updateQRCode() {
        let method = $('#id_payment_mode').val();
        let amount = parseFloat($('#id_tuition_advance_amount').val()) || 0;
        let qrSection = $('#qr-code-section');
        let qrImage = $('#qr-code-img');

        if (method && method.toLowerCase() === 'online' && amount > 0) {
            // ? Generate QR code dynamically from your Django backend
            let qrUrl = `{% url 'generate_qr_dynamic' %}?amount=${amount}`;
            qrImage.attr('src', qrUrl);
            qrSection.show();
        } else {
            // ? Hide QR if not "Online" or invalid amount
            qrSection.hide();
            qrImage.attr('src', '');
        }
    }

    $(document).ready(function () {
        updateQRCode();  // Run on page load
        $('#id_payment_mode, #id_tuition_advance_amount').on('change input', updateQRCode);  // Run on input change
    });
</script>-->

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    function updateQRCode() {
        let method = $('#id_payment_mode').val();
        let amount = parseFloat($('#id_tuition_advance_amount').val()) || 0;
        let qrSection = $('#qr-code-section');
        let qrImage = $('#qr-code-img');

        if (method && method.toLowerCase() === 'online' && amount > 0) {
            // Generate QR code dynamically from your Django backend
            let qrUrl = "{% url 'generate_qr_dynamic' %}?amount=" + amount;
            qrImage.attr('src', qrUrl);
            qrSection.show();
        } else {
            // Hide QR if not "Online" or invalid amount
            qrSection.hide();
            qrImage.attr('src', '');
        }
    }

    function enforceHostelTransportExclusivity() {
        let hostel = $('#id_hostel_fee');
        let transport = $('#id_transport_fee');

        hostel.on('input', function () {
            let hostelVal = parseFloat(hostel.val()) || 0;
            if (hostelVal > 0) {
                transport.val(0);
            }
        });

        transport.on('input', function () {
            let transportVal = parseFloat(transport.val()) || 0;
            if (transportVal > 0) {
                hostel.val(0);
            }
        });
    }

    $(document).ready(function () {
        updateQRCode();  // Run on page load
        $('#id_payment_mode, #id_tuition_advance_amount').on('change input', updateQRCode);  // Run on input change

        enforceHostelTransportExclusivity(); // Enforce fee logic on page load and input
    });
</script>

{% endblock %}

