{% extends "lms/employee_layout.html" %}
{% block title %}Leave Request's List{% endblock %}

{% block content %}
<style>
/* General Container */
.leave-approval-container {
    margin: 10px auto;
    background-color: #fdfdfd;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* Header Flex */
.header-flex {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 15px;
    position: relative;
    flex-wrap: wrap;
}

.header-flex h2 {
    font-weight: 700;
    color: #800000;
    font-size: 22px;
    margin: 0 auto;
    text-align: center;
}

.search-input {
    padding: 6px 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 13px;
    width: 200px;
    margin-bottom: 10px;
}

/* Class Info */
.class-info {
    text-align: center;
    margin-bottom: 15px;
}
.class-info ul {
    list-style: none;
    padding-left: 0;
}
.class-info li {
    font-size: 14px;
    margin-bottom: 4px;
}
.class-info h3 {
    color: #333;
}

/* Table Styling */
table.leave-table {
    width: 100%;
    border-collapse: collapse;
    overflow-x: auto;
}
table.leave-table thead {
    background-color: #800000;
    color: white;
}
table.leave-table th, table.leave-table td {
    padding: 6px 5px;
    border: 1px solid #ddd;
    text-align: center;
    font-size: 12px;
}
table.leave-table td {
    font-size: 11px;
}
table.leave-table tr:nth-child(even) {
    background-color: #f9f9f9;
}

/* Status */
.status-approved { color: green; font-weight: bold; }
.status-rejected { color: red; font-weight: bold; }
.status-pending { color: #ff9800; font-weight: bold; }

/* Action links */
.action-link {
    color: #800000;
    font-weight: bold;
    text-decoration: none;
    margin: 0 3px;
}
.action-link:hover { text-decoration: underline; }

/* Modal */
#confirmModal {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    z-index: 10000;
    align-items: center;
    justify-content: center;
    background: transparent;
}
#confirmModal.show { display: flex; }
.modal-overlay {
    position: absolute;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.4);
    z-index: 1;
}
.modal-box {
    position: relative;
    background: white;
    padding: 20px 25px;
    border-radius: 8px;
    width: 90%;
    max-width: 400px;
    text-align: center;
    z-index: 2;
    box-shadow: 0 5px 15px rgba(0,0,0,0.25);
}
.modal-buttons {
    margin-top: 15px;
    display: flex;
    justify-content: center;
    gap: 15px;
}
.modal-buttons button {
    padding: 8px 15px;
    border: none;
    border-radius: 5px;
    font-weight: bold;
    cursor: pointer;
}
.modal-buttons button:first-child {
    background-color: #800000;
    color: white;
}
.modal-buttons button:last-child {
    background-color: #ccc;
    color: #333;
}
.modal-buttons button:disabled {
    background-color: #ccc !important;
    color: #333 !important;
    cursor: not-allowed;
}

/* Remarks input */
#remarksInput {
    margin-top: 10px;
    width: 100%;
    min-height: 70px;
    resize: vertical;
    padding: 6px;
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-family: inherit;
    display: none;
}
label[for="remarksInput"] {
    display: none;
    font-weight: bold;
    margin-top: 10px;
    text-align: left;
}
#remarksLabel.show { display: block; }

/* Snackbar */
#snackbar {
    visibility: hidden;
    min-width: 200px;
    background-color: #800000;
    color: #fff;
    text-align: center;
    border-radius: 4px;
    padding: 12px 20px;
    position: fixed;
    z-index: 9999;
    left: 50%;
    bottom: 20px;
    transform: translateX(-50%);
    font-size: 14px;
}
#snackbar.show {
    visibility: visible;
    animation: fadein 0.4s, fadeout 0.4s 2.6s;
}
@keyframes fadein { from { bottom:0; opacity:0; } to { bottom:20px; opacity:1; } }
@keyframes fadeout { from { bottom:20px; opacity:1; } to { bottom:0; opacity:0; } }

/* Mobile Responsiveness */
@media screen and (max-width: 768px) {
    table.leave-table th, table.leave-table td {
        font-size: 10px;
        padding: 4px 3px;
    }

    .search-input {
        width: 100%;
        margin-bottom: 10px;
    }

    .modal-box {
        padding: 15px 20px;
    }

    .header-flex {
        flex-direction: column;
        align-items: stretch;
    }

    .class-info li {
        font-size: 12px;
    }
}

/* For extra small screens */
@media screen and (max-width: 480px) {
    table.leave-table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
    }
    .header-flex h2 {
        font-size: 18px;
    }
}
</style>

<div class="leave-approval-container">
    <div class="header-flex">
        <input type="text" id="leaveSearch" class="search-input" placeholder="Search leave requests...">
        <h2>Leave Request's List</h2>
    </div>

    {% if unique_class_list %}
    <div class="class-info">
        <h3>You're Class Teacher For:</h3>
        <ul>
            {% for a in unique_class_list %}
            <li>{{ a.course.name }} - Semester {{ a.semester }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <table class="leave-table">
        <thead>
            <tr>
                <th>Sl No</th>
                <th>Student</th>
                <th>Reason</th>
                <th>From</th>
                <th>To</th>
                <th>Status</th>
                <th>Applied On</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for leave in leaves %}
            <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ leave.student.student_name }}</td>
                <td>{{ leave.reason }}</td>
                <td>{{ leave.from_date }}</td>
                <td>{{ leave.to_date }}</td>
                <td><span class="status-{{ leave.status }}">{{ leave.status|capfirst }}</span></td>
                <td>{{ leave.applied_on|date:"d M Y, H:i" }}</td>
                <td>
                    {% if leave.status == 'pending' %}
                    <a class="action-link" href="{% url 'approve_leave' leave.id %}">Approve</a> |
                    <a class="action-link" href="{% url 'reject_leave' leave.id %}">Reject</a>
                    {% else %}
                    {{ leave.status|capfirst }}
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="8">No leave applications.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal -->
<div id="confirmModal">
    <div class="modal-overlay" onclick="closeConfirmModal()"></div>
    <div class="modal-box">
        <p id="confirmMessage">Are you sure?</p>
        <label id="remarksLabel" for="remarksInput"></label>
        <textarea id="remarksInput" placeholder="Enter remarks here..."></textarea>
        <div class="modal-buttons">
            <button id="confirmYesBtn" disabled>Yes, Continue</button>
            <button id="confirmNoBtn">Cancel</button>
        </div>
    </div>
</div>

<div id="snackbar"></div>

<script>
// Snackbar
function showSnackbar(message) {
    const snackbar = document.getElementById("snackbar");
    snackbar.textContent = message;
    snackbar.className = "show";
    setTimeout(() => snackbar.className = "", 3000);
}

{% if messages %}
    {% for message in messages %}
        showSnackbar("{{ message|escapejs }}");
    {% endfor %}
{% endif %}

let actionUrl = '';
let actionType = '';

function showConfirmPopup(url, type) {
    actionUrl = url;
    actionType = type;

    const confirmMessage = document.getElementById("confirmMessage");
    const remarksInput = document.getElementById("remarksInput");
    const remarksLabel = document.getElementById("remarksLabel");
    const confirmYesBtn = document.getElementById("confirmYesBtn");

    confirmMessage.textContent = `Are you sure you want to ${type} this leave request?`;

    remarksInput.style.display = 'block';
    remarksLabel.classList.add('show');
    remarksInput.value = '';

    confirmYesBtn.disabled = (type === 'reject');
    confirmYesBtn.style.backgroundColor = confirmYesBtn.disabled ? '#ccc' : '#800000';
    confirmYesBtn.style.color = confirmYesBtn.disabled ? '#333' : '#fff';

    remarksInput.focus();
    document.getElementById("confirmModal").classList.add("show");
}

function closeConfirmModal() {
    document.getElementById("confirmModal").classList.remove("show");
}

document.getElementById("remarksInput").addEventListener("input", function () {
    const confirmYesBtn = document.getElementById("confirmYesBtn");
    if (actionType === 'reject') {
        const valid = this.value.trim() !== '';
        confirmYesBtn.disabled = !valid;
        confirmYesBtn.style.backgroundColor = valid ? '#800000' : '#ccc';
        confirmYesBtn.style.color = valid ? '#fff' : '#333';
    }
});

function proceedAction() {
    if (!actionUrl) return;
    const remarks = encodeURIComponent(document.getElementById("remarksInput").value.trim());
    const separator = actionUrl.includes('?') ? '&' : '?';
    window.location.href = `${actionUrl}${separator}remarks=${remarks}`;
}

document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".action-link").forEach(link => {
        link.addEventListener("click", function (e) {
            e.preventDefault();
            showConfirmPopup(this.href, this.textContent.trim().toLowerCase());
        });
    });

    document.getElementById("confirmYesBtn").addEventListener("click", proceedAction);
    document.getElementById("confirmNoBtn").addEventListener("click", closeConfirmModal);

    document.getElementById('leaveSearch').addEventListener('input', function () {
        const filter = this.value.toLowerCase();
        document.querySelectorAll('table.leave-table tbody tr').forEach(row => {
            const rowText = Array.from(row.querySelectorAll('td')).map(td => td.textContent.toLowerCase()).join(' ');
            row.style.display = rowText.includes(filter) ? '' : 'none';
        });
    });
});
</script>
{% endblock %}
