{% extends 'lms/employee_layout.html' %}
{% load static %}
{% block content %}

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    body {
        background-color: #f0f2f5;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
    }

    /* ---------- Main Container ---------- */
    .form-section {
        background: #fff;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
        margin: 20px auto;
        width: 95%;
        max-width: 1200px;
        box-sizing: border-box;
    }

    h4 {
        color: #800000;
        font-size: 22px;
        text-align: center;
        margin-bottom: 25px;
    }

    /* ---------- Labels & Inputs ---------- */
    label {
        font-weight: 600;
        font-size: 13px;
        margin-bottom: 4px;
        display: block;
    }

    select, input[type="date"], input[type="text"], input[type="number"] {
        padding: 7px 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 14px;
        width: 100%;
        box-sizing: border-box;
    }

    input[readonly] {
        background-color: #e9ecef;
    }

    /* ---------- Responsive Grid ---------- */
    .row.g-3 {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        margin-bottom: 15px;
    }

    .col-md-3 {
        flex: 1 1 220px;
        min-width: 180px;
    }

    /* ---------- Table ---------- */
    .table-responsive {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin-top: 20px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
        text-align: center;
    }

    thead {
        background: linear-gradient(#8B0000, #800000);
        color: white;
    }

    th, td {
        border: 1px solid #dee2e6;
        padding: 6px;
        vertical-align: middle;
        white-space: nowrap;
    }

    tr:nth-child(even) {
        background-color: #f8f9fa;
    }

    td input[type="number"] {
        width: 90px;
        text-align: center;
    }

    .error-message {
        color: red;
        font-size: 10px;
        display: none;
    }

    /* ---------- Buttons ---------- */
    .btn-maroon-outline, .btn-success {
        border-radius: 6px;
        padding: 6px 12px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-maroon-outline {
        background-color: #800000;
        color: #fff !important;
        border: 2px solid #800000;
        text-decoration: none;
    }

    .btn-maroon-outline:hover {
        background-color: #660000;
        border-color: #660000;
    }

    .btn-success {
        background-color: #800000 !important;
        border: none;
        color: #fff !important;
    }

    .btn-success:hover {
        background-color: #660000 !important;
    }

    /* ---------- Bottom Buttons ---------- */
    .d-flex {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        gap: 10px;
    }

    /* ---------- Alerts ---------- */
    .alert-warning {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
        padding: 10px;
        border-radius: 5px;
    }

    /* ---------- Popup ---------- */
    #overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0,0,0,0.5);
        display: none;
        z-index: 1000;
    }

    #confirm-popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0,0,0,0.5);
        display: none;
        z-index: 1001;
        text-align: center;
        width: 90%;
        max-width: 300px;
    }

    #confirm-yes, #confirm-no {
        margin: 5px;
        padding: 6px 14px;
        font-size: 12px;
        border-radius: 4px;
        border: 2px solid #800000;
        background: transparent;
        color: #800000;
        font-weight: 600;
        cursor: pointer;
        transition: 0.2s;
    }

    #confirm-yes:hover, #confirm-no:hover {
        background-color: #800000;
        color: white;
    }

    /* ---------- Media Queries ---------- */
    @media (max-width: 992px) {
        .form-section {
            padding: 20px;
            width: 96%;
        }

        table th, table td {
            font-size: 12px;
            padding: 4px;
        }

        td input[type="number"] {
            width: 75px;
        }
    }

    @media (max-width: 768px) {
        .form-section {
            padding: 18px;
            margin: 10px auto;
        }

        h4 {
            font-size: 20px;
        }

        .col-md-3 {
            flex: 1 1 100%;
        }

        .row.g-3 {
            flex-direction: column;
        }

        table {
            font-size: 11.5px;
        }

        th, td {
            padding: 5px;
        }

        td input[type="number"] {
            width: 65px;
        }

        .d-flex {
            flex-direction: column;
            align-items: stretch;
        }

        .btn-maroon-outline, .btn-success {
            width: 100%;
            text-align: center;
        }
    }

    @media (max-width: 480px) {
        .form-section {
            padding: 15px;
        }

        h4 {
            font-size: 18px;
        }

        table {
            font-size: 11px;
        }

        th, td {
            padding: 4px;
        }
    }
</style>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<div class="form-section">
    <h4>Student Marks Entry</h4>

    <!-- Filters -->
    <form method="get" class="row g-3 align-items-center mb-4">
        <div class="col-md-3">
            <label for="course_type">Program Type:</label>
            <select name="course_type" id="course_type" onchange="this.form.submit()">
                <option value="">-- Select Program Type --</option>
                {% for ct in course_types %}
                    <option value="{{ ct.id }}" {% if ct.id|stringformat:"s" == selected.program_type %}selected{% endif %}>{{ ct.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-3">
            <label for="academic_year">Academic Year:</label>
            <select name="academic_year" id="academic_year" onchange="this.form.submit()">
                <option value="">Batch</option>
                {% for year in academic_years %}
                    <option value="{{ year }}" {% if year == selected.academic_year %}selected{% endif %}>{{ year }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-3">
            <label for="course">Course:</label>
            <select name="course" id="course" onchange="this.form.submit()">
                <option value="">-- Select Course --</option>
                {% for c in courses %}
                    <option value="{{ c.id }}" {% if c.id|stringformat:"s" == selected.course %}selected{% endif %}>{{ c.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-3">
            <label for="semester">Semester / Year:</label>
            <select name="semester" id="semester" onchange="this.form.submit()">
                <option value="">-- Select Semester / Year --</option>
                {% for sem in semesters %}
                    <option value="{{ sem.id }}" {% if sem.id|stringformat:"s" == selected.semester|stringformat:"s" %}selected{% endif %}>{{ sem.label }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-3">
            <label for="subject">Subject:</label>
            <select name="subject" id="subject" onchange="this.form.submit()">
                <option value="">-- Select Subject --</option>
                {% for sub in subjects %}
                    <option value="{{ sub.id }}" {% if sub.id|stringformat:"s" == selected.subject|stringformat:"s" %}selected{% endif %}>{{ sub.name }}</option>
                {% endfor %}
            </select>
        </div>
    </form>

    <!-- Class Dropdown -->
    {% if assignments and assignments|length > 1 %}
        <form method="get" class="mb-3 d-flex justify-content-center">
            <label for="assignment" class="me-2 fw-bold">Select Class:</label>
            <select name="assignment" id="assignment" class="form-select w-auto me-2" onchange="this.form.submit()">
                <option value="">-- Select Class --</option>
                {% for assign in assignments %}
                    <option value="{{ assign.id }}" {% if assignment and assignment.id == assign.id %}selected{% endif %}>
                        {{ assign.course.name }} - Semester {{ assign.semester }}
                    </option>
                {% endfor %}
            </select>
        </form>
    {% endif %}

    <!-- Students Table -->
    {% if students %}
        <form method="post">
            {% csrf_token %}
            <div class="table-responsive">
                <table class="table table-bordered table-hover mt-3 align-middle text-center">
                    <thead class="table-dark">
                        <tr>
                            <th>Roll No</th>
                            <th>Student Name</th>
                            <th>Academic Year</th>
                            <th>Course / Semester</th>
                            <th>Subject</th>
                            <th>Internal Max</th>
                            <th>Internal Obtained</th>
                            <th>Final Max</th>
                            <th>Final Obtained</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pair in student_form_pairs %}
                            <tr>
                                <td>{{ pair.student.student_userid }}</td>
                                <td>{{ pair.student.student_name }}</td>
                                <td>{{ pair.student.academic_year }}</td>
                                <td>{{ pair.student.course }} -
                                    {% if pair.student.semester %}{{ pair.student.semester }}{% else %}{{ pair.student.current_year }}{% endif %}
                                </td>
                                <td>{% if pair.subject %}{{ pair.subject.name }}{% else %}-{% endif %}</td>
                                <td>{{ pair.internal_max|default:"-" }}</td>
                                <td>{{ pair.internal_obtained|default:"0.0" }}</td>
                                <td><input type="number" name="max_marks_{{ pair.student.id }}" value="{{ pair.form.initial.max_marks }}" readonly></td>
                                <td>
                                    <div class="marks-input">
                                        <input type="number" name="marks_obtained_{{ pair.student.id }}" value="{{ pair.form.initial.marks_obtained }}" min="0" max="{{ pair.form.initial.max_marks }}">
                                        <div class="error-message"></div>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="d-flex mt-4">
                <a href="{% url 'student_marks_list' %}" class="btn-maroon-outline">
                    <i class="bi bi-arrow-left"></i> Back
                </a>
                <button type="submit" class="btn-success">
                    <i class="bi bi-save"></i> Save Marks
                </button>
            </div>
        </form>
    {% elif assignments and not students %}
        <div class="alert alert-warning text-center fw-bold">
            ⚠️ No students found for your class.
        </div>
    {% endif %}
</div>

<script>
document.addEventListener("input", function(e) {
    if (e.target.name.startsWith("marks_obtained_")) {
        let max = parseFloat(e.target.getAttribute("max"));
        let val = parseFloat(e.target.value);
        let errorDiv = e.target.parentElement.querySelector(".error-message");

        if (val > max) {
            errorDiv.innerText = "Marks cannot exceed " + max;
            errorDiv.style.display = "block";
        } else if (val < 0) {
            errorDiv.innerText = "Marks cannot be negative";
            errorDiv.style.display = "block";
        } else {
            errorDiv.innerText = "";
            errorDiv.style.display = "none";
        }
    }
});
</script>

{% endblock %}
