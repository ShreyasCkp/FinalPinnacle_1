name: Build and deploy Django App to Azure Web App (Raw Deploy)

on:
push:
branches:
- main
workflow_dispatch:

env:
APP_NAME: pinnacle-college-final
RESOURCE_GROUP: pinnacle-college
PYTHON_VERSION: '3.9'
DJANGO_SETTINGS_MODULE: student_alerts_app.deployment

jobs:
build_and_deploy:
runs-on: ubuntu-latest


steps:
# 1Ô∏è‚É£ Checkout repository
- name: Checkout code
  uses: actions/checkout@v4

# 2Ô∏è‚É£ Install system dependencies
- name: Install system dependencies
  run: |
    sudo apt-get update
    sudo apt-get install -y \
      libcairo2 libcairo2-dev \
      libpango-1.0-0 libpangocairo-1.0-0 \
      libgdk-pixbuf2.0-0 libffi-dev shared-mime-info \
      libjpeg-dev zlib1g-dev build-essential pkg-config

# 3Ô∏è‚É£ Set up Python
- name: Setup Python
  uses: actions/setup-python@v5
  with:
    python-version: ${{ env.PYTHON_VERSION }}

# 4Ô∏è‚É£ Cache pip dependencies
- name: Cache pip
  uses: actions/cache@v3
  with:
    path: ~/.cache/pip
    key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
    restore-keys: |
      ${{ runner.os }}-pip-

# 5Ô∏è‚É£ Create venv and install dependencies
- name: Create virtual environment and install dependencies
  run: |
    python -m venv venv
    source venv/bin/activate
    pip install --upgrade pip
    pip install -r requirements.txt

# 6Ô∏è‚É£ Make startup.sh executable
- name: Make startup.sh executable
  run: chmod +x startup.sh

# 7Ô∏è‚É£ Run Django migrations
- name: Run Django migrations
  env:
    DJANGO_SETTINGS_MODULE: ${{ env.DJANGO_SETTINGS_MODULE }}
  run: |
    source venv/bin/activate
    python manage.py migrate --noinput

# 8Ô∏è‚É£ Collect static files
- name: Collect static files
  env:
    DJANGO_SETTINGS_MODULE: ${{ env.DJANGO_SETTINGS_MODULE }}
  run: |
    source venv/bin/activate
    python manage.py collectstatic --noinput

# 9Ô∏è‚É£ Azure login
- name: Azure login
  uses: azure/login@v2
  with:
    creds: ${{ secrets.AZURE_CREDENTIALS }}

# üîü Set Azure Web App environment variables
- name: Set Azure Web App environment variables
  uses: azure/cli@v1
  with:
    inlineScript: |
      az webapp config appsettings set \
        --name ${{ env.APP_NAME }} \
        --resource-group ${{ env.RESOURCE_GROUP }} \
        --settings \
        DB_NAME='${{ secrets.DB_NAME }}' \
        DB_USER='${{ secrets.DB_USER }}' \
        DB_PASSWORD='${{ secrets.DB_PASSWORD }}' \
        DB_HOST='${{ secrets.DB_HOST }}' \
        DB_PORT='${{ secrets.DB_PORT }}'

# 1Ô∏è‚É£1Ô∏è‚É£ Deploy Django app (raw folder deploy)
- name: Deploy app to Azure Web App (no ZIP)
  uses: azure/cli@v1
  with:
    inlineScript: |
      echo "Deploying project files to Azure Web App..."
      az webapp deploy \
        --name ${{ env.APP_NAME }} \
        --resource-group ${{ env.RESOURCE_GROUP }} \
        --src-path . \
        --type war --async false

# 1Ô∏è‚É£2Ô∏è‚É£ Confirm deployed files
- name: Verify deployment files
  uses: azure/cli@v1
  with:
    inlineScript: |
      echo "Deployment complete. Verifying files..."
      az webapp ssh --name ${{ env.APP_NAME }} --resource-group ${{ env.RESOURCE_GROUP }}
