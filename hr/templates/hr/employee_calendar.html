{% extends 'lms/employee_layout.html' %}
{% block title %}Employee Calendar{% endblock %}
{% block content %}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .calendar-container {
        display: flex;
        flex-wrap: nowrap;
        gap: 2rem;
        padding: 7px;
        margin-top: 25px;
        justify-content: center;
    }

    .calendar-box {
        flex: 0 0 60%;
        padding: 15px;
        border-radius: 15px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        background: #fff;
        text-align: center;
    }

    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

        .calendar-header h2 {
            color: #8b0000;
            font-weight: 700;
            font-size: 22px;
            margin: 0 auto;
        }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 6px;
    }

    .calendar-day-name {
        font-weight: 500;
        background-color: #8b0000;
        color: white;
        padding: 4px 0;
        border-radius: 6px;
        font-size: 12px;
    }

    .calendar-day {
        position: relative;
        background-color: #ffffff;
        border: 1px solid #d1c4e9;
        padding: 6px 0;
        border-radius: 6px;
        color: #333;
        font-size: 13px;
        text-align: center;
        cursor: pointer;
        min-height: 40px;
    }

        .calendar-day.today {
            background-color: #8b0000;
            color: #fff;
            border: 2px solid #8b0000;
            font-weight: bold;
        }


        .calendar-day .tooltip-dates {
            visibility: hidden;
            opacity: 0;
            background: #333;
            color: #fff;
            text-align: center;
            padding: 4px 8px;
            border-radius: 6px;
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            white-space: nowrap;
            transition: opacity 0.3s;
            z-index: 10;
        }

        .calendar-day:hover .tooltip-dates {
            visibility: visible;
            opacity: 1;
        }

    .calendar-legend {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 12px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
    }

    .legend-color {
        width: 14px;
        height: 14px;
        border-radius: 3px;
        display: inline-block;
    }

    .green {
        background-color: #28a745;
    }

    .yellow {
        background-color: #ffc107;
    }

    .black {
        background-color: #000;
    }

    .event-box {
        flex: 0 0 35%;
        padding: 20px;
        border-radius: 16px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        background: #fff;
        max-height: 520px;
        overflow-y: auto;
    }

        .event-box h3 {
            color: #8b0000;
            font-weight: 700;
            font-size: 18px;
            margin-bottom: 15px;
        }

    .leave-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .leave-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #fafafa;
        border: 1px solid #ddd;
        border-left: 5px solid #8b0000;
        padding: 10px 12px;
        border-radius: 6px;
        margin-bottom: 10px;
        transition: background 0.2s;
        font-size: 14px;
    }

        .leave-item:hover {
            background: #f1f1f1;
        }

    .status-green {
        color: #28a745;
        font-weight: 600;
    }

    .status-yellow {
        color: #ffc107;
        font-weight: 600;
    }

    .status-black {
        color: #000;
        font-weight: 600;
    }

    .btn-secondary {
        background-color: #800;
        color: white;
        /*sixe: 19px;*/
        /* padding: 12px; */
        font-size: 10px;
        border: none !important;
        padding: 5px;
        border-radius: 4px;
    }

    .modal-body {
        font-size: 11px;
        color: #800;
    }

    .blue {
        background-color: #007bff;
    }

    .calendar-day.green,
    .calendar-day.yellow,
    .calendar-day.black,
    .calendar-day.blue {
        background-color: #fff; /* keep box white */
        border: 2px solid; /* border color will be set individually */
        border-radius: 8px;
        font-weight: bold;
        color: inherit; /* optional, can keep same text color */
    }

    .calendar-day.green {
        border-color: #28a745;
        color: #28a745;
    }

    .calendar-day.yellow {
        border-color: #ffc107;
        color: #ffc107;
    }

    .calendar-day.black {
        border-color: #000;
        color: #000;
    }

    .calendar-day.blue {
        border-color: #007bff;
        color: #007bff;
    }
</style>

<div class="calendar-container">
    <!-- Calendar -->
    <div class="calendar-box">
        <div class="calendar-header">
            <a href="?month={{ prev_month }}&year={{ prev_year }}" class="btn btn-sm btn-outline-secondary">&lt;</a>
            <h2>{{ month_name }} {{ year }}</h2>
            <a href="?month={{ next_month }}&year={{ next_year }}" class="btn btn-sm btn-outline-secondary">&gt;</a>

            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#balanceLeavesModal">
                + Balance Leaves
            </button>
        </div>

        <div class="calendar-grid">
            {% for day in weekdays %}
            <div class="calendar-day-name">{{ day }}</div>
            {% endfor %}

            {% for week in month_days %}
            {% for day in week %}
            {% if day == 0 %}
            <div class="calendar-day"></div>
            {% else %}
            <div class="calendar-day
                    {% for item in highlights_json %}
                        {% if item.date_day == day and item.date_month == month and item.date_year == year %}
                            {{ item.color }}
                        {% endif %}
                    {% endfor %}
                    {% if today.day == day and today.month == month and today.year == year %} today{% endif %}
                ">
                {{ day }}
                <div class="tooltip-dates">
                    {% for item in highlights_json %}
                    {% if item.date_day == day and item.date_month == month and item.date_year == year %}
                    {{ item.title }}
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            {% endfor %}
            {% endfor %}
        </div>

        <!-- Legend -->
        <div class="calendar-legend">
            <div class="legend-item"><span class="legend-color green"></span> Approved</div>
            <div class="legend-item"><span class="legend-color yellow"></span> Pending</div>
            <div class="legend-item"><span class="legend-color black"></span> Holiday</div>
            <div class="legend-item"><span class="legend-color blue"></span> Academic Event</div>

        </div>
    </div>

    <!-- Leaves / Holidays List -->
    <div class="event-box">
        <h3>üìå Your Leaves & Holidays</h3>
        <ul class="leave-list">
            {% for leave in leaves_list %}
            <li class="leave-item">
                <div>
                    {{ leave.start|date:"d M, Y" }} ‚Üí {{ leave.end|date:"d M, Y" }} | {{ leave.leave_type }} |

                    {% if leave.status == 'Approved' %}
                    {% if leave.start > today %}
                    <a href="{% url 'edit_leave_redirect' leave.id %}" class="status-green" style="text-decoration: underline;">
                        {{ leave.status }}
                    </a>
                    {% else %}
                    <span class="status-green">{{ leave.status }}</span>
                    {% endif %}

                    {% elif leave.status == 'Pending' %}
                    <span class="status-yellow">{{ leave.status }}</span>

                    {% elif leave.status == 'Rejected' %}
                    <span class="status-red" style="color: red;">{{ leave.status }}</span>
                    {% endif %}
                </div>

                <!-- Hidden cancel form -->
                <form id="cancel-form-{{ leave.id }}" method="POST"
                      action="{% url 'edit_leave_cancel' leave.id %}" style="display:none;">
                    {% csrf_token %}
                </form>
            </li>
            {% endfor %}




            {% for item in highlights_json %}
            {% if item.color == 'black' %}
            <li class="leave-item">
                <div>
                    {{ item.date_day }} {{ month_name }}, {{ item.date_year }} | {{ item.title }} |
                    <span class="status-black">Holiday</span>
                </div>
            </li>
            {% endif %}
            {% endfor %}
        </ul>
        <ul class="leave-list">
            {% for event in academic_events %}

            <li class="leave-item">
                <div>
                    {{ event.date|date:"d M, Y" }} | {{ event.title }}
                    {% if event.time %} ({{ event.time }}) {% endif %}
                    <br>
                    <small style=" color: darkorange;">{{ event.description }}</small>
                </div>
            </li>
            {% empty %}
            <li class="leave-item text-muted">No academic events this month.</li>
            {% endfor %}
        </ul>
    </div>
</div>

<!-- Cancel Leave Modal -->
<div class="modal fade" id="cancelLeaveModal" tabindex="-1" aria-labelledby="cancelLeaveModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style=" width: 422px;">
            <div class="modal-header" style="font-size: 12px; color: #800;">
                <h5 class="modal-title" id="cancelLeaveModalLabel" style="font-size: 15px;">Cancel Leave</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to cancel <span id="leave-name"></span>?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" data-bs-dismiss="modal">No, Keep Leave</button>
                <button type="button" class="btn-secondary" id="confirm-cancel-btn">Yes, Cancel Leave</button>
            </div>
        </div>
    </div>
</div>

<!-- Balance Leaves Modal -->
<div class="modal fade" id="balanceLeavesModal" tabindex="-1" aria-labelledby="balanceLeavesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="balanceLeavesModalLabel">üìù Your Leave Balances</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul class="leave-list">
                    {% for lb in leave_balances_list %}
                    <li class="leave-item">
                        {{ lb.leave_type }}: {{ lb.balance }} / {{ lb.allowed }} remaining
                    </li>
                    {% endfor %}
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    let leaveIdToCancel = null;
    const cancelLeaveModal = document.getElementById('cancelLeaveModal');

    if (cancelLeaveModal) {
        cancelLeaveModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            leaveIdToCancel = button.getAttribute('data-leave-id');
            const leaveName = button.getAttribute('data-leave-name');
            document.getElementById('leave-name').textContent = leaveName;
        });

        document.getElementById('confirm-cancel-btn').onclick = function () {
            if (leaveIdToCancel) {
                document.getElementById('cancel-form-' + leaveIdToCancel).submit();
            }
        };
    }

</script>

{% endblock %}
